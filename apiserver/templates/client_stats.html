<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据统计</title>
    <style>
        /* 基础样式与manage.html保持一致 */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f5f7fa; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { color: #2c3e50; }
        .nav-links { display: flex; gap: 15px; }
        .nav-link { color: #3498db; text-decoration: none; padding: 8px 12px; border-radius: 4px; }
        .nav-link:hover, .nav-link.active { background: #3498db; color: white; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        .card h2 { color: #2c3e50; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #2c3e50; margin: 10px 0; }
        .stat-label { color: #666; font-size: 14px; }
        .table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .table th { background: #fafbfc; color: #555; }
        .table tr:hover { background: #f9fafb; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; text-decoration: none; }
        .btn-primary { background: #3498db; color: white; }
        .btn-default { background: #f5f5f5; color: #333; }
        .flash-messages { margin-bottom: 20px; }
        .flash-success { padding: 10px; background: #dff0d8; color: #3c763d; border-radius: 4px; margin-bottom: 10px; }
        .flash-error { padding: 10px; background: #f2dede; color: #a94442; border-radius: 4px; margin-bottom: 10px; }
        .chart-container { height: 300px; margin: 20px 0; }
        .filter-bar { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
        .pagination { margin-top: 20px; display: flex; gap: 5px; justify-content: center; }
        .pagination a { padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #3498db; }
        .pagination a.active { background: #3498db; color: white; border-color: #3498db; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; text-align: center; color: #666; }
        .author-link { color: #3498db; text-decoration: none; }
        .author-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部导航 -->
        <div class="header">
            <h1>数据统计中心</h1>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="nav-links">
                    <a href="/manage" class="nav-link">配置管理</a>
                    <a href="/client_stats" class="nav-link active">数据统计</a>
                    {% if is_admin %}
                        <a href="/applications" class="nav-link">修改申请</a>
                    {% endif %}
                </div>
                <div>
                    {% if is_admin %}
                        <span>管理员: {{ session.username }} </span>
                        <a href="/change_password" class="btn btn-default" style="margin-left: 10px;">修改密码</a>
                        <a href="/logout" class="btn btn-default">退出</a>
                    {% else %}
                        <a href="/login" class="nav-link">管理员登录</a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 消息提示 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- 1. 客户端统计概览 -->
        <div class="card">
            <h2>客户端访问统计</h2>
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-label">总设备数</div>
                    <div class="stat-value">{{ overview.total_devices }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">今日活跃设备</div>
                    <div class="stat-value">{{ overview.today_active }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">总访问次数</div>
                    <div class="stat-value">{{ overview.total_access }}</div>
                </div>
            </div>
            
            <h3>近7天活跃设备趋势</h3>
            <div class="chart-container">
                <canvas id="activeTrendChart"></canvas>
            </div>
            
            <h3>设备列表</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>设备ID</th>
                        <th>首次访问</th>
                        <th>最后访问</th>
                        <th>访问次数</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in detail.devices %}
                    <tr>
                        <td>{{ device.device_id }}</td>
                        <td>{{ device.first_access }}</td>
                        <td>{{ device.last_access }}</td>
                        <td>{{ device.access_count }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666;">暂无设备数据</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- 分页 -->
            {% if detail.total_pages > 1 %}
            <div class="pagination">
                {% for page in range(1, detail.total_pages + 1) %}
                    <a href="/client_stats?page={{ page }}{% if current_status %}&reward_status={{ current_status }}{% endif %}" 
                       class="{% if page == detail.current_page %}active{% endif %}">
                        {{ page }}
                    </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- 2. 奖励领取结果统计 -->
        <div class="card">
            <h2>奖励领取结果统计</h2>
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-label">总任务数</div>
                    <div class="stat-value">{{ reward_stats.total_count }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">成功数</div>
                    <div class="stat-value" style="color: #28a745;">{{ reward_stats.success_count }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">失败数</div>
                    <div class="stat-value" style="color: #dc3545;">{{ reward_stats.fail_count }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">成功率</div>
                    <div class="stat-value">{{ reward_stats.success_rate }}%</div>
                </div>
            </div>
            
            <div class="filter-bar">
                <span>筛选：</span>
                <a href="/client_stats" class="btn {% if not current_status %}btn-primary{% else %}btn-default{% endif %}">全部</a>
                <a href="/client_stats?reward_status=success" class="btn {% if current_status == 'success' %}btn-primary{% else %}btn-default{% endif %}">成功</a>
                <a href="/client_stats?reward_status=fail" class="btn {% if current_status == 'fail' %}btn-primary{% else %}btn-default{% endif %}">失败</a>
            </div>
            
            <h3>任务结果列表</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>设备名称</th>
                        <th>总任务数</th>
                        <th>任务ID</th>
                        <th>状态</th>
                        <th>响应码</th>
                        <th>任务时间</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in reward_data.results %}
                    <tr>
                        <td>{{ result.device_name }}</td>
                        <td>{{ result.total_tasks }}</td>
                        <td>{{ result.task_id }}</td>
                        <td>
                            <span style="color: {{ 'green' if result.status == 'success' else 'red' }}">
                                {{ result.status }}
                            </span>
                        </td>
                        <td>{{ result.response_code }}</td>
                        <td>{{ result.task_timestamp }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" style="text-align: center; color: #666;">暂无任务结果数据</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- 分页 -->
            {% if reward_data.total_pages > 1 %}
            <div class="pagination">
                {% for page in range(1, reward_data.total_pages + 1) %}
                    <a href="/client_stats?reward_page={{ page }}{% if current_status %}&reward_status={{ current_status }}{% endif %}" 
                       class="{% if page == reward_data.current_page %}active{% endif %}">
                        {{ page }}
                    </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- 页脚（包含作者信息） -->
        <div class="footer">
            <p>© 2024 配置管理系统</p>
            <div>
                作者: <a href="https://b23.tv/bRWJZMR" target="_blank" class="author-link">ocean之下【ocean之下的个人空间-哔哩哔哩】</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // 绘制活跃设备趋势图
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('activeTrendChart').getContext('2d');
            
            // 准备图表数据
            const labels = {{ overview.week_trend | map(attribute='date') | list | tojson }};
            const data = {{ overview.week_trend | map(attribute='active_count') | list | tojson }};
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '活跃设备数',
                        data: data,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
    